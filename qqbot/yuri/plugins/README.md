# QQ机器人插件说明

## 插件概述

本项目包含两个主要插件：

1. **yuri_bot.py** - AI聊天插件（基于Ollama）
2. **sign_in.py** - 签到积分插件

## 最新更新

### 并发处理优化 (v2.0)
- **优化的锁管理**：智能锁管理器，自动清理过期锁，防止内存泄漏
- **连接池优化**：支持自动重连和健康检查的数据库连接池
- **速率限制**：防止API滥用，保护系统稳定性
- **任务管理**：并发任务管理器，控制同时执行的任务数量
- **性能监控**：实时监控响应时间和系统资源使用情况
- **错误重试**：指数退避重试机制，提高操作成功率

### yuri_bot.py 更新
- **待机状态支持**：当Ollama不可用时，插件会进入待机状态而不是完全停止
- **自动重连**：每30秒检查一次Ollama连接状态，连接恢复后自动启用AI功能
- **状态提示**：在待机状态下会提示用户等待连接恢复
- **连接监控**：实时监控Ollama服务状态，记录连接变化日志
- **AI调用限制**：每分钟最多20次AI调用，防止资源耗尽

### sign_in.py 更新
- **群组隔离**：每个群聊的积分完全独立，不会相互同步
- **数据库结构优化**：支持多群组数据分离存储
- **数据迁移工具**：提供迁移脚本处理现有数据
- **操作限制**：每分钟最多30次数据库操作，防止数据库过载

## 功能特性

### yuri_bot.py (AI聊天插件)
- 🤖 AI聊天对话
- ✍️ 百合写作生成
- 💭 多轮上下文记忆
- 🔄 自动连接恢复
- 🛡️ 敏感词过滤
- 📊 状态监控
- ⚡ 速率限制保护
- 🔒 并发任务管理

### sign_in.py (签到插件)
- 📅 每日签到
- 🏆 积分排行榜
- 💰 积分系统
- 🔄 补签功能
- 📊 积分流水记录
- 🏢 群组独立积分
- ⚡ 操作频率限制
- 🔒 数据库连接池

## 安装和配置

### 1. 依赖安装
```bash
pip install psutil aiomysql
```

### 2. 数据库设置
```sql
-- 创建数据库和用户
CREATE DATABASE nonebot_signin CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'signin'@'localhost' IDENTIFIED BY 'signin';
GRANT ALL PRIVILEGES ON nonebot_signin.* TO 'signin'@'localhost';
FLUSH PRIVILEGES;
```

### 3. 数据迁移（如果需要）
如果之前使用过签到插件，需要运行迁移脚本：
```bash
cd QQBot/yuri/plugins
python migrate_signin_db.py
```

### 4. Ollama设置
确保Ollama服务运行在 `http://127.0.0.1:11434`，并加载了以下模型：
- `yuri_chat` - 聊天模型
- `yuri_write` - 写作模型

## 使用方法

### AI聊天插件命令
- `@机器人 你好` - 直接对话
- `/写作 写一个百合故事` - AI写作
- `/记忆 开/关` - 开启/关闭上下文记忆
- `/清除记忆` - 清除对话记忆
- `/状态` - 查看当前状态
- `/help` - 查看帮助

### 签到插件命令
- `@机器人 签到` - 每日签到
- `@机器人 积分` - 查看积分
- `@机器人 积分排行` - 查看排行榜
- `@机器人 补签` - 补签功能
- `@机器人 积分流水` - 查看积分记录
- `/help` - 查看帮助

## 配置说明

### 数据库配置
在 `sign_in.py` 中修改 `DB_CONFIG`：
```python
DB_CONFIG = {
    'host': 'localhost',
    'user': 'signin',
    'password': 'signin',
    'db': 'nonebot_signin',
    'charset': 'utf8mb4'
}
```

### Ollama配置
在 `yuri_bot.py` 中修改：
```python
OLLAMA_URL = "http://127.0.0.1:11434"
MODEL_CHAT = "yuri_chat"
MODEL_WRITE = "yuri_write"
```

### 通知配置
修改启动通知的群组和用户ID：
```python
STARTUP_NOTICE_GROUPS = [284205050]  # 群号列表
STARTUP_NOTICE_USERS = [2193807541, 1185329732]  # 用户ID列表
```

## 故障排除

### AI聊天插件问题
1. **Ollama连接失败**
   - 检查Ollama服务是否运行
   - 确认端口11434是否开放
   - 查看日志中的连接错误信息

2. **模型加载失败**
   - 确认模型名称是否正确
   - 检查模型是否已下载到Ollama

3. **速率限制问题**
   - 每分钟最多20次AI调用
   - 如果频繁触发限制，请稍后重试

### 签到插件问题
1. **数据库连接失败**
   - 检查MySQL服务状态
   - 确认数据库配置信息
   - 验证用户权限

2. **数据迁移问题**
   - 运行迁移脚本前备份数据库
   - 检查数据库表结构

3. **操作频率限制**
   - 每分钟最多30次数据库操作
   - 避免短时间内重复操作

### 性能问题
1. **响应缓慢**
   - 检查系统资源使用情况
   - 查看性能监控日志
   - 考虑调整并发限制

2. **内存使用过高**
   - 检查锁管理器是否正常清理
   - 监控连接池使用情况
   - 重启服务释放资源

## 日志监控

插件会记录以下日志信息：
- 连接状态变化
- 错误和异常
- 用户操作记录
- 系统状态信息
- 性能指标统计
- 并发任务状态
- 速率限制触发
- 系统资源使用情况

### 性能监控
系统会自动记录以下性能指标：
- 操作响应时间
- 成功率统计
- 并发任务数量
- 内存和CPU使用率
- 数据库连接状态

每5分钟会输出一次性能摘要到日志中。

## 注意事项

1. **数据备份**：定期备份数据库数据
2. **权限管理**：确保数据库用户权限正确
3. **资源监控**：监控Ollama服务资源使用情况
4. **安全考虑**：定期更新敏感词过滤列表
5. **并发控制**：避免同时执行过多操作
6. **速率限制**：遵守API调用频率限制
7. **性能监控**：定期检查系统性能指标
8. **内存管理**：监控锁和连接池使用情况

## 技术支持

如遇到问题，请检查：
1. 日志文件中的错误信息
2. 数据库连接状态
3. Ollama服务状态
4. 网络连接情况
